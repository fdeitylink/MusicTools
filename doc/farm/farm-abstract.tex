%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[sigplan,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}

%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{CONF} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2018}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations

%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption
\usepackage{listings}

\begin{document}

%% Title information
\title{Demo: Counterpoint by Construction}
%\subtitle{Functional Pearl}

%% Author information
%% Contents and number of authors suppressed with 'anonymous'.

%% Author with single affiliation.
\author{Youyou Cong}
\affiliation{
  \institution{Tokyo Institute of Technology}            %% \institution is required
  \city{Tokyo}
  \country{Japan}
}
\email{cong@c.titech.ac.jp}          %% \email is recommended

\author{John Leo}
\affiliation{
  \institution{Halfaya Research}            %% \institution is required
  \city{Bellevue}
  \state{WA}
  \country{USA}
}
\email{leo@halfaya.org}          %% \email is recommended


%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code

%% Keywords
%% comma separated list
% \keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

Western music of the common practice period tends to loosely
follow sets of rules, which were developed over time to ensure
the aesthetic quality of the composition. 
Among these rules, those for harmony \citep{piston1987harmony}
and counterpoint (harmonically interdependent
melodies) \citep{fux1965study} are particularly fundamental and continue
to be taught to music students,
not only as a means to understand the music of that period, but
also as a foundation for modern art and popular music.

To help analyze and synthesize tonal music, it is worthwhile to
encode these rules into a programming language. As shown by
recent studies, functional programming languages are particularly
suited to this task.
In the past decade, Haskell has been extensively used to encode
the rules of harmony \citep{fmmh, hihseufha, faamh, hafha, fghm}
as well as counterpoint \citep{szamozvancev2017well}.
Haskell's static type sytem is used to encode these rules, so that
``well-typed music does not sound wrong''.
Unfortunately the type system of plain Haskell
is not powerful enough to guarantee these properties. Previous studies
have thus incorporated language extensions such as GADTs 
\citep{cheney2002lightweight} and singleton types 
\citep{eisenberg2013dependently} to approximate dependently-typed 
programming.

In this demonstration of work in progress, we present Music Tools
\citep{MusicTools}, a library of small tools that can be combined
functionally to help analyze and synthesize music.
To allow simple and natural encoding of rules, we built the library
in Agda \citep{norellphd}, which is a functional language with full
dependent types.
As an application of the library, we demonstrate an implementation of 
species counterpoint, based on the rules given by \citet{fux1965study}.
Thanks to Agda's rich type system, we can express 
these rules naturally, and thus ensure by construction that
well-typed counterpoint satisfies all the required rules.

As an example, the simplest of Fux's rule systems is first-species
counterpoint, in which one starts with a base melody (the \textit{cantus firmus})
and contructs a counterpoint melody note-by-note in the same rhythm.
``Dissonant'' intervals (2nds, 7ths and 4ths) are probibited, as are
are parallel and similar motion of perfect intervals (5ths and octaves).
The latter is encoded in Agda as follows.

\begin{lstlisting}
motionOk : (i1 : Interval)
           (i2 : Interval) → Set
motionOk i1 i2 with motion i1 i2
         | isPerfectInterval i2
motionOk i1 i2 | contrary | _     = ⊤
motionOk i1 i2 | oblique  | _     = ⊤
motionOk i1 i2 | parallel | false = ⊤
motionOk i1 i2 | parallel | true  = ⊥
motionOk i1 i2 | similar  | false = ⊤
motionOk i1 i2 | similar  | true  = ⊥
\end{lstlisting}

The music must also end with a cadence, which is a final motion from
the second or seventh degree to the tonic (first degree). These rules
are encoded in the following type, whose terms are exactly valid
first-species counterpoint.

\begin{lstlisting}
data FirstSpecies : PitchInterval →
                    Set where
  cadence2 : (p : Pitch) →
    FirstSpecies
      (transpose (+ 2) p , maj6)
  cadence7 : (p : Pitch) →
    FirstSpecies
      (transpose -[1+ 0 ] p , min10)
  _::_ : (pi : PitchInterval) →
         {pj : PitchInterval} →
         {_ : motionOk pi pj} →
         FirstSpecies pj →
         FirstSpecies pi
\end{lstlisting}

Explicit conversions from \texttt{PitchInterval} (which ensures
the inteval is not dissonant) to the general \texttt{Interval} have
been omitted in the listing above.
Note that \texttt{motionOk} is an implicit argument of the cons
constructor, and is able to be resolved automatically by the type checker,
and thus the proof does not need to be supplied by the user. Valid
first-species counterpoint can thus be written very naturally as
in the following simple example.

\begin{lstlisting}
example : FirstSpecies (g 4 , per8)
example = 
  (g 4 , per8) :: (c 5 , maj10) ::
  (c 5 , per8) :: (c 5 , maj10) ::
  (e 5 , min10) :: (g 5 , per8) ::
  (cadence2 (c 6))
\end{lstlisting}

At the FARM workshop, we intend to give a gentle introduction to
counterpoint, and describe our Agda implementation, showing how the
type-based approach both aids human composition and allows for 
computer-generated creation of correct counterpoint.
We then contrast our work to a recent study on generating
natural-sounding counterpoint by machine learning
\citep{CounterpointByConvolution}, which does not provide correctness
guarantees.
Finally, we discuss further applications of our library, including
representation of functional harmony.


%% Acknowledgments
\begin{acks}                            %% contents suppressed with 'anonymous'
 The authors would like to thank the participants of the Tokyo Agda 
 Implementors' Meeting, especially Ulf Norell and Jesper Cockx,
 for many helpful suggestions that improved our Agda code.
\end{acks}


%% Bibliography
\bibliography{farm-abstract.bib}

\end{document}
