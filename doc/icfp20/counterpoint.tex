\section{Counterpoint}
\label{sec:cp}

Counterpoint is a technique for combining multiple lines of melodies.
Composing counterpoint is like arranging a song for choir:
we start with a \emph{cantus firmus}, which serves as the base melody,
and compose counterpoint lines above or below the cantus firmus.
When doing this, we must make sure that the counterpoint lines sound
harmonically pleasing when played with the cantus firmus,
and that the individual melodic lines are distinguishable to the listener.

In this section, we present an implementation of species counterpoint,
based on the formulation given by Fux~\citep{fux-cp}.
The idea is to represent ``good'' counterpoint  as a dependent record,
whose fields encode the musical content as well as proofs that the
counterpoint follows certain rules.
For space reason, we only describe two variants of species counterpoint;
other variants can be formalized in an analogous way.

\subsection{First Species Counterpoint}
\label{sec:cp:fs}

First species counterpoint is the simplest variant of counterpoint.
In first species, we set one note against each note in the cantus firmus,
which starts with a tonic and consists only of whole notes.
Here is an example of first species counterpoint, where the lower line
stands for the cantus firmus and the upper line represents the
counterpoint\footnote{The cantus firmus is part of a German song
  called ``Froschgesang'' (Frog's song).}:

[Frog score]

We represent such music in the following way: we keep the first and
last bars as separate elements, and encode the middle bars as a vector
of pitch-interval pairs \texttt{(p , i)}, where \texttt{p} is a note in the
cantus firmus, and \texttt{i} is the distance between \texttt{p} and the
corresponding counterpoint note.
For instance, the main body of the above example is represented as
follows:

\begin{alltt}
PitchInterval : Set
PitchInterval = Pitch \(\times\) Interval

cfcp1 : List PitchInterval
cfcp1 = (d 5 , maj6) :: (e 5 , min6) :: (f 5 , maj3) :: (e 5 , min3) :: (d 5 , maj6) :: []
\end{alltt}

The reason we separate different parts of the music is that they are
subject to different rules.
In the reminder of this section, we elaborate these rules one by one.

\paragraph{Beginning}
The beginning of the music must be a perfect consonance,
that is, it must be a unison, a 5th, or an 8th.
In our implementation, this is checked by the predicate
\texttt{checkBeginning}, which is defined as follows:

\begin{alltt}
data BeginningError : Set where
  not158   : PitchInterval \(\rightarrow\) BeginningError
  
checkBeginning : PitchInterval \(\rightarrow\) Maybe BeginningError
checkBeginning pi@(_ , i) =
  if ((i == per1) \(\vee\) (i == per5) \(\vee\) (i == per8))
  then nothing
  else just (not158 pi)
\end{alltt}

\noindent The datatype \texttt{BeginningError} is a kind of
``type error'' designed specifically for counterpoint.
The first constructor \texttt{not158} tells us that the music
begins with a wrong interval, whereas the second constructor
\texttt{tooShort} says that the whole music is empty.
With this datatype, we can obtain an informative error message
when we accidentally break the rule at the beginning of the music.
Thus, what we are doing here can be seen as writing a
customized typechecker.

\paragraph{Intervals}
In the main body of the music, we must ensure that vertical intervals
are harmonically pleasing.
all intervals must be consonant.
That is, we should only use 3rds, 5ths, 6ths, and 8ths.
This rule can be encoded as the \texttt{checkIntervals} predicate,
which again uses a new datatype \texttt{IntervalError} representing
the presence of a dissonant interval:

\begin{alltt}
data IntervalError : Set where
  dissonant : Interval \(\rightarrow\) IntervalError

intervalCheck : Interval \(\rightarrow\) Maybe IntervalError
intervalCheck i = if isConsonant i then nothing else just (dissonant i)

checkIntervals : List PitchInterval \(\rightarrow\) List IntervalError
checkIntervals = mapMaybe (intervalCheck \(\circ\) proj\(\sb{\mathtt{2}}\))
\end{alltt}

\paragraph{Motion}

\begin{alltt}
data Motion : Set where
contrary : Motion
parallel : Motion
similar  : Motion
oblique  : Motion
\end{alltt}

For every pair of two adjacent intervals, the cantus firmus and
counterpoint lines must not move in the same direction if the second
interval is a perfect one (i.e., unison, 5th, or 8th).
This is because such motion would draw too much attention to the
resulting interval.

\begin{alltt}
data MotionError : Set where
  parallel : PitchInterval \(\rightarrow\) PitchInterval \(\rightarrow\) MotionError
  similar  : PitchInterval \(\rightarrow\) PitchInterval \(\rightarrow\) MotionError

motionCheck : PitchInterval \(\rightarrow\) PitchInterval \(\rightarrow\) Maybe MotionError
motionCheck i1 i2 with motion i1 i2 | isPerfect (proj\(\sb{\mathtt{2}}\) i2)
motionCheck i1 i2 | contrary | \_     = nothing
motionCheck i1 i2 | oblique  | \_     = nothing
motionCheck i1 i2 | parallel | false = nothing
motionCheck i1 i2 | parallel | true  = just (parallel i1 i2)
motionCheck i1 i2 | similar  | false = nothing
motionCheck i1 i2 | similar  | true  = just (similar i1 i2)

checkMotion : List PitchInterval → List MotionError
checkMotion = mapMaybe (uncurry motionCheck) ∘ pairs  
\end{alltt}

\paragraph{Unisons}
Unisons should not occur in the main body of the music.
The reason is that they make it harder to distinguish between
the two melodic lines.

\begin{alltt}
data UnisonError : Set where
  unison : Pitch \(\rightarrow\) UnisonError

unisonCheck : PitchInterval \(\rightarrow\) Maybe UnisonError
unisonCheck (p , i) = if (i == per1) then just (unison p) else nothing

checkUnison : List PitchInterval \(\rightarrow\) List UnisonError
checkUnison = mapMaybe unisonCheck
\end{alltt}

\paragraph{Ending}
The ending of the music must be a \emph{cadence}, a progression
of two intervals that gives rise to a sense of resolution.